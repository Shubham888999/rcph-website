<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RCPH - Sign In</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div style="max-width:420px;margin:4rem auto;padding:16px;background:#1e1e1e;border-radius:12px;">
    <h2 style="text-align:center;margin-top:0;">Sign In</h2>
    <input id="email" type="email" placeholder="Email"
           style="width:100%;padding:10px;margin:.5rem 0;border-radius:8px;border:1px solid #2e2e2e;background:#101010;color:#fff;">
    <input id="password" type="password" placeholder="Password"
           style="width:100%;padding:10px;margin:.5rem 0;border-radius:8px;border:1px solid #2e2e2e;background:#101010;color:#fff;">
    <button id="loginBtn" class="btn" style="width:100%;margin-top:.5rem;">Login</button>

    <button id="googleBtn" class="btn" style="width:100%;margin-top:.5rem;">
  Continue with Google
</button>
    <div style="margin-top:8px; text-align:right;">
  <button id="forgotBtn" class="btn btn-outline" style="padding:6px 10px;">Forgot password?</button>
</div>

<!-- Add under the "Forgot password?" button -->
<div id="otpBox" style="margin-top:14px; border-top:1px solid #333; padding-top:12px; display:none;">
  <div style="display:flex; gap:8px; align-items:center;">
    <input id="otpEmail" type="email" placeholder="Email for OTP"
      style="flex:2; padding:10px; border-radius:8px; border:1px solid #2e2e2e; background:#101010; color:#fff;">
    <button id="otpSend" class="btn btn-outline">Get code</button>
  </div>

  <div id="otpStep2" style="display:none; margin-top:10px;">
    <input id="otpCode" type="text" placeholder="Enter 6-digit code"
      style="width:160px; padding:10px; margin-right:8px; border-radius:8px; border:1px solid #2e2e2e; background:#101010; color:#fff;">
    <input id="otpNewPass" type="password" placeholder="New password"
      style="width:220px; padding:10px; margin-right:8px; border-radius:8px; border:1px solid #2e2e2e; background:#101010; color:#fff;">
    <button id="otpConfirm" class="btn">Set password</button>
  </div>

  <p id="otpMsg" style="color:#ccc; margin-top:8px;"></p>
</div>


<!-- ‚ñº‚ñº‚ñº NEW FORM LINKS SECTION -->
<div style="margin-top:20px; padding:10px; border-top:1px solid #333;">
  <p style="margin:8px 0 4px; font-size:14px; color:#ddd; font-weight:500;">üí∞ Reimbursement Form</p>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe5OXooAMkyD35Dl0KtRElDmwi1MMXd-ANHHJ4Z8ozp6NziZg/viewform?usp=header"
     target="_blank"
     style="display:inline-block; color:#6be0dc; font-size:13px; text-decoration:underline;">
    Open Google Form
  </a>

  <p style="margin:16px 0 4px; font-size:14px; color:#ddd; font-weight:500;">‚ö†Ô∏è Fine Repayment</p>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSc-KbmpxbB1k6KoML3HNh5oVrqDSzU_WZExhAF6wwGgnKoxEg/viewform?usp=header"
     target="_blank"
     style="display:inline-block; color:#6be0dc; font-size:13px; text-decoration:underline;">
    Open Google Form
  </a>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ END NEW FORM LINKS SECTION -->

    <p id="authError" style="color:#ff6b6b;margin-top:10px;min-height:1.2em;"></p>

    <!-- ‚ñº‚ñº‚ñº ADD THIS: panel chooser (hidden by default; shown for admins) -->
    <div id="panelChooser" style="display:none;max-width:420px;margin:1rem 0 0;padding:12px;border:1px solid #2e2e2e;border-radius:12px;background:#161616">
      <p style="margin:.25rem 0 1rem 0">Where do you want to go?</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a href="admin.html" class="btn" style="flex:1;text-align:center">Admin Panel</a>
        <a href="bodlogin.html" class="btn btn-outline" style="flex:1;text-align:center">BOD Panel</a>
      </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ END chooser -->
  </div>

  <!-- Firebase SDKs (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <!-- Your init (must come AFTER the SDKs) -->
  <script src="firebase-init.js"></script>
  <script>
  // Show OTP box instead of the default link flow (optional: toggle via a small text link)
  document.getElementById('forgotBtn').onclick = () => {
    document.getElementById('otpBox').style.display = 'block';
  };

  async function callFn(name, data) {
    const fn = firebase.app().functions ? firebase.functions() : firebase.app().functions();
    return fn.httpsCallable(name)(data).then(r => r.data);
  }

  const otpSend = document.getElementById('otpSend');
  const otpConfirm = document.getElementById('otpConfirm');
  const otpMsg = document.getElementById('otpMsg');

  otpSend.onclick = async () => {
    const email = document.getElementById('otpEmail').value.trim();
    if (!email) { otpMsg.textContent = 'Enter your email.'; return; }
    otpMsg.textContent = 'Sending code‚Ä¶';
    try {
      await callFn('requestPasswordOtp', { email });
      otpMsg.textContent = 'Code sent! Check your inbox.';
      document.getElementById('otpStep2').style.display = 'block';
    } catch (e) {
      otpMsg.textContent = e.message || 'Failed to send code.';
    }
  };

  otpConfirm.onclick = async () => {
    const email = document.getElementById('otpEmail').value.trim();
    const otp   = document.getElementById('otpCode').value.trim();
    const newPw = document.getElementById('otpNewPass').value;
    if (!email || !otp || !newPw) { otpMsg.textContent = 'Fill all fields.'; return; }
    otpMsg.textContent = 'Verifying‚Ä¶';
    try {
      await callFn('resetPasswordWithOtp', { email, otp, newPassword: newPw });
      otpMsg.textContent = 'Password updated! You can login now.';
    } catch (e) {
      otpMsg.textContent = e.message || 'Failed to reset.';
    }
  };
</script>

  <!-- ‚ñº‚ñº‚ñº REPLACE your <script> with this one -->
  <script>
    // use the instances from firebase-init.js
    const auth = window.auth;
    const db   = window.db;

    // already signed in? route
auth.onAuthStateChanged(async (user) => {
  if (!user) return; // no one signed in yet ‚Äî stay on login screen
  // Wait until login button explicitly triggers route
});
    async function routeByRole(user){
      try {
        const snap = await db.collection('roles').doc(user.uid).get();
        if (!snap.exists || !snap.data().role) {
          await auth.signOut();
          showError("No role set for this user. Contact admin.");
          return;
        }

        const role = String(snap.data().role || '').toLowerCase();

        // Optional: respect deep link like ?dest=admin or ?dest=bod
        const destParam = new URLSearchParams(location.search).get('dest');
        if (destParam === 'admin') { location.href = 'admin.html'; return; }
        if (destParam === 'bod')   { location.href = 'bodlogin.html'; return; }

        // Optional: remember choice
        const preferred = localStorage.getItem('preferredPanel');
        if (role === 'admin' && (preferred === 'admin' || preferred === 'bod')) {
          location.href = preferred === 'admin' ? 'admin.html' : 'bodlogin.html';
          return;
        }

        if (role === 'admin') {
          // show chooser for admins instead of auto-redirect
          document.getElementById('panelChooser').style.display = 'block';

          // If you want "remember my choice", you can add a checkbox and set localStorage here.
          // Example: localStorage.setItem('preferredPanel', 'admin' or 'bod') when clicking a link.
          return;
        }

        if (role === 'bod') {
          location.href = 'bodlogin.html';
          return;
        }

        // Unknown role
        await auth.signOut();
        showError(`Unknown role "${role}". Contact admin.`);
      } catch (e) {
        showError(e.message || "Could not read role.");
      }
    }

    document.getElementById('loginBtn').onclick = async () => {
      const email = document.getElementById('email').value.trim();
      const pass  = document.getElementById('password').value;
      try {
        const cred = await auth.signInWithEmailAndPassword(email, pass);
        routeByRole(cred.user);
      } catch (e) {
        showError(e.message);
      }
    };

document.getElementById('googleBtn').onclick = async () => {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      // Optional: force account picker each time:
      // provider.setCustomParameters({ prompt: 'select_account' });

      const cred = await auth.signInWithPopup(provider);
      await afterGoogleSignIn(cred.user); // see next section
    } catch (e) {
      document.getElementById('authError').textContent = e.message || 'Google sign-in failed.';
    }
  };
    
    document.getElementById('forgotBtn').onclick = async () => {
  const email = document.getElementById('email').value.trim();
  if (!email) { showError('Enter your email first.'); return; }
  try {
    await auth.sendPasswordResetEmail(email);
    showError('Reset link sent. Check your inbox.');
  } catch (e) {
    showError(e.message || 'Could not send reset email.');
  }
};

    function showError(msg){ document.getElementById('authError').textContent = msg || ""; }
  </script>
  <!-- ‚ñ≤‚ñ≤‚ñ≤ END script -->
</body>
</html>