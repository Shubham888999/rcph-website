<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RCPH - Sign In</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div style="max-width:420px;margin:4rem auto;padding:16px;background:#1e1e1e;border-radius:12px;">
    <h2 style="text-align:center;margin-top:0;">Sign In</h2>
    <input id="email" type="email" placeholder="Email"
           style="width:100%;padding:10px;margin:.5rem 0;border-radius:8px;border:1px solid #2e2e2e;background:#101010;color:#fff;">
    <input id="password" type="password" placeholder="Password"
           style="width:100%;padding:10px;margin:.5rem 0;border-radius:8px;border:1px solid #2e2e2e;background:#101010;color:#fff;">
    <button id="loginBtn" class="btn" style="width:100%;margin-top:.5rem;">Login</button>

    <button id="googleBtn" class="btn" style="width:100%;margin-top:.5rem;">
  Continue with Google
</button>
    <div style="margin-top:8px; text-align:right;">
  <button id="forgotBtn" class="btn btn-outline" style="padding:6px 10px;">Forgot password?</button>
</div>

<div id="otpBox" style="margin-top:14px; border-top:1px solid #333; padding-top:12px; display:none;">
  <div style="display:flex; gap:8px; align-items:center;">
    <input id="otpEmail" type="email" placeholder="Email for OTP"
      style="flex:2; padding:10px; border-radius:8px; border:1px solid #2e2e2e; background:#101010; color:#fff;">
    <button id="otpSend" class="btn btn-outline">Get code</button>
  </div>

  <div id="otpStep2" style="display:none; margin-top:10px;">
    <input id="otpCode" type="text" placeholder="Enter 6-digit code"
      style="width:160px; padding:10px; margin-right:8px; border-radius:8px; border:1px solid #2e2e2e; background:#101010; color:#fff;">
    <input id="otpNewPass" type="password" placeholder="New password"
      style="width:220px; padding:10px; margin-right:8px; border-radius:8px; border:1px solid #2e2e2e; background:#101010; color:#fff;">
    <button id="otpConfirm" class="btn">Set password</button>
  </div>

  <p id="otpMsg" style="color:#ccc; margin-top:8px;"></p>
</div>

<div style="margin-top:20px; padding:10px; border-top:1px solid #333;">
  <p style="margin:8px 0 4px; font-size:14px; color:#ddd; font-weight:500;">üí∞ Reimbursement Form</p>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSe5OXooAMkyD35Dl0KtRElDmwi1MMXd-ANHHJ4Z8ozp6NziZg/viewform?usp=header"
     target="_blank"
     style="display:inline-block; color:#6be0dc; font-size:13px; text-decoration:underline;">
    Open Google Form
  </a>

  <p style="margin:16px 0 4px; font-size:14px; color:#ddd; font-weight:500;">‚ö†Ô∏è Fine Repayment</p>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSc-KbmpxbB1k6KoML3HNh5oVrqDSzU_WZExhAF6wwGgnKoxEg/viewform?usp=header"
     target="_blank"
     style="display:inline-block; color:#6be0dc; font-size:13px; text-decoration:underline;">
    Open Google Form
  </a>
</div>

    <p id="authError" style="color:#ff6b6b;margin-top:10px;min-height:1.2em;"></p>

    <!-- Panel chooser (hidden by default; shown for admins) -->
    <div id="panelChooser" style="display:none;max-width:420px;margin:1rem 0 0;padding:12px;border:1px solid #2e2e2e;border-radius:12px;background:#161616">
      <p style="margin:.25rem 0 1rem 0">Where do you want to go?</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <a href="admin.html" class="btn" style="flex:1;text-align:center">Admin Panel</a>
        <a href="bodlogin.html" class="btn btn-outline" style="flex:1;text-align:center">BOD Panel</a>
      </div>
    </div>
    <!-- END chooser -->
  </div>

 <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="firebase-init.js"></script>
<script>
  const auth = window.auth;
  const db   = window.db;
  (async function completeRedirectIfAny() {
    try {
      const result = await auth.getRedirectResult();
      if (result && result.user) {
        await routeByRole(result.user);
        return;
      }
    } catch (e) {
      console.warn('getRedirectResult:', e && e.code, e && e.message);
    }
  })();

  document.getElementById('googleBtn').onclick = async () => {
    const provider = new firebase.auth.GoogleAuthProvider();

    try {
      const res = await auth.signInWithPopup(provider);
      await routeByRole(res.user);
    } catch (e) {
      // If popup blocked or unsupported, fallback to redirect
      if (e && (e.code === 'auth/popup-blocked' || e.code === 'auth/operation-not-supported-in-this-environment')) {
        try {
          await auth.signInWithRedirect(provider);
          // Page navigates; the result is handled by getRedirectResult() above
        } catch (er) {
          document.getElementById('authError').textContent = er.message || 'Google sign-in failed (redirect).';
        }
      } else {
        document.getElementById('authError').textContent = e.message || 'Google sign-in failed (popup).';
      }
    }
  };

async function routeByRole(user) {
  const err = (m) => document.getElementById('authError').textContent = m || '';

  try {
    const snap = await db.collection('roles').doc(user.uid).get();
    if (!snap.exists || !snap.data().role) {
      await auth.signOut();
      err('No role set for this user. Contact admin.');
      return;
    }

    const role = String(snap.data().role || '').toLowerCase();
    const dest = new URLSearchParams(location.search).get('dest');
    if (dest === 'admin') { location.href = 'admin.html'; return; }
    if (dest === 'bod')   { location.href = 'bodlogin.html'; return; }

    if (role === 'admin' || role === 'president') {
      document.getElementById('panelChooser').style.display = 'block';
      const preferred = localStorage.getItem('preferredPanel');
      if (preferred === 'admin') { location.href = 'admin.html'; return; }
      if (preferred === 'bod')   { location.href = 'bodlogin.html'; return; }
      return;
    }

    if (role === 'bod') {
      location.href = 'bodlogin.html';
      return;
    }
    if (role === 'dzr') {
  location.href = 'dzrvisit.html';
  return;
}


    await auth.signOut();
    err(`Unknown role "${role}". Contact admin.`);
  } catch (e) {
    err(e.message || 'Could not read role.');
  }
}
  document.getElementById('loginBtn').onclick = async () => {
    const email = document.getElementById('email').value.trim();
    const pass  = document.getElementById('password').value;

    if (!email || !pass) {
      document.getElementById('authError').textContent = 'Enter email and password.';
      return;
    }

    try {
      const cred = await auth.signInWithEmailAndPassword(email, pass);
      await routeByRole(cred.user);
    } catch (e) {
      document.getElementById('authError').textContent =
        e.message || 'Login failed.';
    }
  };
</script>
</body>
</html>